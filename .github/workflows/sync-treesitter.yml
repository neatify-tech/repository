name: Sync tree-sitter binaries

on:
  workflow_dispatch:
  schedule:
    - cron: "15 3 * * *"

permissions:
  contents: write

env:
  NEATIFY_REPO: neatify-tech/neatify
  TREESITTER_REPOS: |
    neatify-tech/tree-sitter-css
    neatify-tech/tree-sitter-html
    neatify-tech/tree-sitter-java
    neatify-tech/tree-sitter-json
    neatify-tech/tree-sitter-markdown
    neatify-tech/tree-sitter-rhai
    neatify-tech/tree-sitter-rust
    neatify-tech/tree-sitter-sql
    neatify-tech/tree-sitter-typescript
    neatify-tech/tree-sitter-vue

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download tree-sitter releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          temp_dir="$(mktemp -d)"
          while IFS= read -r repo; do
            [[ -z "$repo" ]] && continue
            repo_name="${repo##*/}"
            gh release download -R "$repo" -p "tree-sitter-*" -D "$temp_dir/$repo_name" --clobber
          done <<'EOF'
${TREESITTER_REPOS}
EOF
          shopt -s nullglob
          for asset in "$temp_dir"/*/tree-sitter-*; do
            base="$(basename "$asset")"
            if [[ "$base" =~ ^tree-sitter-(.+)-([^-]+)-([^-]+)\.([^.]+)$ ]]; then
              lang="${BASH_REMATCH[1]}"
              os="${BASH_REMATCH[2]}"
              arch="${BASH_REMATCH[3]}"
              ext="${BASH_REMATCH[4]}"
              dest="core/treesitter/${os}/${arch}"
              mkdir -p "$dest"
              cp "$asset" "$dest/${lang}.${ext}"
            fi
          done
      - name: Generate manifest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          temp_dir="$(mktemp -d)"
          gh release download -R "$NEATIFY_REPO" -p "neatify-*-linux-x86_64.tar.gz" -D "$temp_dir" --clobber
          tar -xzf "$temp_dir"/neatify-*-linux-x86_64.tar.gz -C "$temp_dir"
          chmod +x "$temp_dir/neatify"
          "$temp_dir/neatify" --generate-manifest
      - name: Commit updates
        shell: bash
        run: |
          set -euo pipefail
          git add core/treesitter manifest.toml
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update tree-sitter binaries and manifest"
          git push
